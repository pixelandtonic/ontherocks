/*!
 * Craft by Pixel & Tonic
 *
 * @package   Craft
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2013, Pixel & Tonic, Inc.
 * @license   http://buildwithcraft.com/license1.0.html Craft License
 * @link      http://buildwithcraft.com
 */
(function(a){Craft.Locales=Garnish.Base.extend({$addLocaleField:null,$addLocaleInput:null,$resultsSheet:null,$resultsList:null,$activeLocale:null,locales:null,selectedLocales:null,adminTable:null,inputVal:null,showingResultsSheet:false,init:function(b,c){this.locales={};for(var d in b){this.locales[d]={name:b[d],words:Craft.asciiString(d+" "+b[d]).match(Craft.Locales.wordRegex)}}this.selectedLocales=c;this.$addLocaleField=a("#addlocale");this.$addLocaleInput=a("#addlocaleinput");this.adminTable=new Craft.AdminTable({tableSelector:"#locales",sortable:true,allowDeleteAll:false,reorderAction:"localization/reorderLocales",deleteAction:"localization/deleteLocale",confirmDeleteMessage:"Are you sure you want to delete “{name}” and all its associated content?",onDeleteObject:a.proxy(function(f){var e=a.inArray(f,this.selectedLocales);if(e!=-1){this.selectedLocales.splice(e,1)}},this)});this.addListener(this.$addLocaleInput,"keydown","onKeyDown");this.addListener(this.$addLocaleInput,"focus","onFocus");this.addListener(this.$addLocaleInput,"blur","onBlur")},onKeyDown:function(b){switch(b.keyCode){case Garnish.ESC_KEY:this.$addLocaleInput.val("");this.hideResultsSheet();return;case Garnish.RETURN_KEY:b.preventDefault();this.addSelectedLocale();return;case Garnish.UP_KEY:this.setRelativeActiveLocale("prev");return;case Garnish.DOWN_KEY:this.setRelativeActiveLocale("next");return}setTimeout(a.proxy(this,"checkInputVal"),1)},onFocus:function(){if(this.inputVal){this.showResultsSheet()}},onBlur:function(){this.hideResultsSheet()},setRelativeActiveLocale:function(b){if(this.$activeLocale){var c=this.$activeLocale.parent()[b]().children("a");if(c.length){this.$activeLocale.removeClass("hover");c.addClass("hover");this.$activeLocale=c}}},checkInputVal:function(){if(this.inputVal!==(this.inputVal=this.$addLocaleInput.val())){var f=this.findMatchingLocales();if(f.length){f=f.sort(function(h,g){return h.length-g.length});this.showResultsSheet();this.$resultsList.html("");for(var c=0;c<f.length;c++){var b=this.locales[f[c]],e=a("<li/>").appendTo(this.$resultsList),d=a('<a data-id="'+f[c]+'">'+b.name+" ("+f[c]+")</a>").appendTo(e);if(c==0){d.addClass("hover");this.$activeLocale=d}}}else{this.hideResultsSheet();this.$activeLocale=null}}},findMatchingLocales:function(){var k=[],f=Craft.asciiString(this.inputVal).match(Craft.Locales.wordRegex);if(f){var e=[];for(var d=0;d<f.length;d++){e.push(new RegExp("^"+f[d],"i"))}for(var h in this.locales){if(Craft.inArray(h,this.selectedLocales)){continue}var g=true;for(var d=0;d<e.length;d++){var b=false;for(var c=0;c<this.locales[h].words.length;c++){if(this.locales[h].words[c].search(e[d])!=-1){b=true;break}}if(!b){g=false;break}}if(g){k.push(h)}}}return k},showResultsSheet:function(){if(!this.showingResultsSheet){if(!this.$resultsSheet){this.$resultsSheet=a('<div id="addlocaleresults" class="menu" style="position: relative; margin: 0 1px;"/>').appendTo(this.$addLocaleField);this.$resultsList=a("<ul/>").appendTo(this.$resultsSheet);this.addListener(this.$resultsList,"mousedown","addSelectedLocale")}this.$resultsSheet.show();this.showingResultsSheet=true}},hideResultsSheet:function(){if(this.showingResultsSheet){this.$resultsSheet.hide();this.showingResultsSheet=false}},addSelectedLocale:function(c){if(c){var b=a(c.target)}else{if(!this.$activeLocale){return}var b=this.$activeLocale}var d=b.attr("data-id");Craft.postActionRequest("localization/addLocale",{id:d},a.proxy(function(e){if(e.success){var f=a('<tr data-id="'+d+'" data-name="'+this.locales[d].name+'"><th scope="row" data-title="'+Craft.t("Name")+'" width="40%">'+this.locales[d].name+'</th><td data-title="'+Craft.t("Locale ID")+'">'+d+'</td><td class="thin"><a class="move icon" title="'+Craft.t("Reorder")+'"></a></td><td class="thin"><a class="delete icon" title="'+Craft.t("Delete")+'"></a></td></tr>');this.adminTable.addRow(f);this.selectedLocales.push(d);this.$addLocaleInput.val("").trigger("keydown");this.checkInputVal();Craft.cp.displayNotice(Craft.t("New locale added."))}else{Craft.cp.displayError(Craft.t("Unable to add the new locale."))}},this))}},{wordRegex:new RegExp("[a-zA-Z]+","g")})})(jQuery);